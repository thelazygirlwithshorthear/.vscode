image: node:lts

cache:
  key:
    files:
      - yarn.lock
  paths:
    - node_modules/
     - out

stages:
  - build
  - test
  - publish

build:
  stage: build
  tags: 
   - kubernetes
  script: 
   - yarn install
   - yarn run compile

lint:
  stage: test
  tags: 
    - kubernetes
  script: 
    - yarn install
    - yarn run lint

test:
  variables:
    DOCUMENTS_DATABASE_SERVER: documents-database
    DSDS_HOST: documents-server
    DOCUMENTSENV_LogPath: $CI_PROJECT_DIR/D5Log_[TIMESTAMP].log
  parallel:
    matrix:
      - VERSION: ["latest", "trunk"]
  services:
   - name: docker.otris.de/docker/documents/documents-mariadb:$VERSION
     alias: documents-database
   - name: docker.otris.de/docker/documents/documents-server-grantall:$VERSION
     alias: documents-server
  stage: test
  tags: 
   - kubernetes
  image: docker.otris.de/docker/ci-build
  script: 
   - yarn install
   - yarn run compile
   - yarn run compile-tests
   - wait-for -t 900 documents-server:11000
   - yarn run init-test-server
   - yarn test
  artifacts:
    when: always
    paths:
      - D5Log_*
    reports:
      junit: test.*.xml

publish-dev:
  when: manual
  only:
    - develop@janus/node-sds
  stage: publish
  tags: 
    - kubernetes
  script:
    - yarn install
    - "echo -e \"\\n//registry.otris.de/:_authToken=\\\"$NPM_AUTH_TOKEN\\\"\\nalways-auth = true\" >> .npmrc"
    - npm run do-prepublish
    - yarn config set registry https://registry.otris.de
    - npm install -g @otr-tools/otr-build --registry https://registry.otris.de
    - otr-build publish --skip-latest

publish-intern:
  only:
    - tags
  stage: publish
  tags: 
    - kubernetes
  script:
    - yarn install
    - "echo -e \"\\n//registry.otris.de/:_authToken=\\\"$NPM_AUTH_TOKEN\\\"\\nalways-auth = true\" >> .npmrc"
    - npm run do-prepublish
    - yarn config set registry https://registry.otris.de
    - yarn global add @otr-tools/otr-build --registry https://registry.otris.de
    - otr-build publish
